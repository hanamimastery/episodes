<p>[ðŸŽ¬Â 01] Hi there!</p>
<p>With the <a href="https://github.com/hanami/hanami">introduction of Hanami 2.1</a> the view layer get's in place so I've decided to play a bit with the form helpers to show you how we could use them.</p>
<p>[ðŸŽ¬Â 02] I have here an application, the same that I've created in  <a href="/episodes/40-hanamismith">episode 40</a>, presenting <a href="https://www.alchemists.io/projects/hanamismith/">Hanamismith</a>. I just prettified it a little bit since then, using bulma CSS framework.</p>
<p>[ðŸŽ¬Â 03] For more details about integrating it, I encourage you to check episodes 2 and 3, where I've shown how to list articles using Bulma and Hanami-view.</p>
<p>![[Pasted image 20230506111815.png]]</p>
<p>[ðŸŽ¬Â 04] It allows users to click a button and pretend to subscribe to my <a href="https://www.youtube.com/channel/UC4Z5nwSfZrUO4NI_n9SY3uQ">youtube channel</a>. Of course, that's just a fake for lamers.</p>
<p>[ðŸŽ¬Â 05] If you want to subscribe for real, I'm sure you know what to do ;).</p>
<p>[ðŸŽ¬Â 06] In this episode, though, I'm going to write a contact page, in case people will realize to their big surprise that the action is not fully working and will notice that after refreshing the page, their subscription is not persisted.</p>
<p>I want them to be able to report to me that the subscription is not working, so I can tell them, that it's not a bug but a feature, and properly redirect them to my youtube channel.</p>
<p>Please do not ask how much sense it has, I'm just having some fun here!</p>
<p>We'll use a contact form that after submitting, will send an email to our great customer support team, which is me actually.</p>
<p>So let's start then.</p>
<h1><a href="#before-we-start" aria-hidden="true" class="anchor" id="before-we-start"></a>Before we start.</h1>
<p>[ðŸŽ¬Â 07] Please keep in mind, that Until Hanami 2.1 is officially released, I've switched Hanami-related gems in my <code>Gemfile</code> to be loaded from the <code>main</code> git branch from the GitHub repositories.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#8fa1b3;">gem </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, , </span><span style="color:#a3be8c;">github: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami/hanami</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">branch: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">main</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">gem </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami-cli</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">github: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami/cli</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">branch: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">main</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">gem </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami-devtools</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">github: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami/devtools</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">branch: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">main</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">gem </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami-utils</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">github: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami/utils</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">branch: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">main</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">gem </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami-controller</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">github: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami/controller</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">branch: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">main</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">gem </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami-router</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">github: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami/router</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">branch: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">main</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">gem </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami-validations</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">github: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami/validations</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">branch: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">main</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">gem </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami-view</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">github: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">hanami/view</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">branch: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">main</span><span style="color:#c0c5ce;">&quot;
</span>
</code></pre>
<p>[ðŸŽ¬Â 08] If you watch this video after the Hanami 2.1 is released, you won't need all of this and you'll just be able to work with defaults.</p>
<h1><a href="#contact-page" aria-hidden="true" class="anchor" id="contact-page"></a>Contact Page</h1>
<p>[ðŸŽ¬Â 09] First of all, I want to create a contact page. At the moment I only have my home page available, but I want a separate page to show the contact form. For that I need the route to render it, so let me add it now.</p>
<pre lang="ruby" style="background-color:#2b303b;"><code>
<span style="color:#65737e;"># slices/main/config/routes.rb
</span><span style="color:#c0c5ce;">get &quot;</span><span style="color:#a3be8c;">/contact</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#a3be8c;">to: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">home.contact</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#a3be8c;">as: :contact
</span>
</code></pre>
<p>[ðŸŽ¬Â 10] Now I want to add a new <code>show</code> action, for my contact page. For now, I do nothing here, just rendering the corresponding view object.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#65737e;"># slices/main/actions/home/contact.rb
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Main
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Actions
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Contact
</span><span style="color:#c0c5ce;">      </span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Show </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">Main::Action
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">handle</span><span style="color:#c0c5ce;">(*, </span><span style="color:#bf616a;">response</span><span style="color:#c0c5ce;">) = response.render view
</span><span style="color:#c0c5ce;">      </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span>
</code></pre>
<p>[ðŸŽ¬Â 11] Now Let me create the view. [ðŸŽ¬Â 12] I'll expose the <code>title</code> method here so I can access it in the view, and will add this as a method below.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#65737e;"># slices/main/views/contact/show.rb
</span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Main
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Views
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Contact
</span><span style="color:#c0c5ce;">      </span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Show </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">Main::View
</span><span style="color:#c0c5ce;">        expose </span><span style="color:#a3be8c;">:title
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">title
</span><span style="color:#c0c5ce;">          &quot;</span><span style="color:#a3be8c;">Cannot subscribe?! Oh no! Let us know what happens!</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">      </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span>
</code></pre>
<p>Exposing strings like this is useful for potential localization in the future and easier testing in isolation.</p>
<p>[ðŸŽ¬Â 13] Now I just need to add a template. This time I'll use the standard ERB engine to parse my ruby code into HTML. While I'm not a fan of it anymore and you'll see more <code>slim</code> templates in my tutorials in the future, I think it's ok to show that this is also an option.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#65737e;"># slices/main/templates/contact/show.html.erb
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">&lt;h1 </span><span style="color:#b48ead;">class</span><span style="color:#c0c5ce;">=&quot;</span><span style="color:#a3be8c;">notification is-primary</span><span style="color:#c0c5ce;">&quot;&gt;
</span><span style="color:#c0c5ce;">  &lt;%= title %&gt;
</span><span style="color:#a3be8c;">&lt;/h1</span><span style="color:#c0c5ce;">&gt;
</span>
</code></pre>
<p>[ðŸŽ¬Â 14] Now when I start my server, and visit the <code>/contact</code> URL, you'll see that a new page is rendered properly :). Great!</p>
<p>![[Pasted image 20230506111905.png]]</p>
<h1><a href="#navigation" aria-hidden="true" class="anchor" id="navigation"></a>Navigation</h1>
<p>[ðŸŽ¬Â 15] To easier switch my pages, It would be useful to have a quick navigation for my pages at the top, so let me jump into the application layout and add a simple navigation snippet there.</p>
<p>[ðŸŽ¬Â 16] For each page, I'm going to use the <code>link_to</code> helper, to show the link pointing to my custom pages. I type the text to show as a first argument and the path as a second argument.</p>
<p>At the end I'm adding the <code>navbar-item</code> HTML class, so it will be presented in a nice way leveraging <em>Bulma</em> integration.</p>
<pre lang="html" style="background-color:#2b303b;"><code>
<span style="color:#c0c5ce;"># slices/main/layouts/app.html.erb
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">nav </span><span style="color:#d08770;">class</span><span style="color:#c0c5ce;">=&quot;</span><span style="color:#a3be8c;">navbar</span><span style="color:#c0c5ce;">&quot; </span><span style="color:#d08770;">role</span><span style="color:#c0c5ce;">=&quot;</span><span style="color:#a3be8c;">navigation</span><span style="color:#c0c5ce;">&quot; </span><span style="color:#d08770;">aria-label</span><span style="color:#c0c5ce;">=&quot;</span><span style="color:#a3be8c;">main navigation</span><span style="color:#c0c5ce;">&quot;&gt;
</span><span style="color:#c0c5ce;">  &lt;</span><span style="color:#bf616a;">div </span><span style="color:#d08770;">class</span><span style="color:#c0c5ce;">=&quot;</span><span style="color:#a3be8c;">navbar-menu</span><span style="color:#c0c5ce;">&quot;&gt;
</span><span style="color:#c0c5ce;">    &lt;</span><span style="color:#bf616a;">div </span><span style="color:#d08770;">class</span><span style="color:#c0c5ce;">=&quot;</span><span style="color:#a3be8c;">navbar-start</span><span style="color:#c0c5ce;">&quot;&gt;
</span><span style="color:#c0c5ce;">      &lt;%= link_to(&#39;Home&#39;, routes.path(:root), class: &#39;navbar-item&#39;) %&gt;
</span><span style="color:#c0c5ce;">      &lt;%= link_to(&#39;Contact&#39;, routes.path(:contact), class: &#39;navbar-item&#39;) %&gt;
</span><span style="color:#c0c5ce;">    &lt;/</span><span style="color:#bf616a;">div</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">  &lt;/</span><span style="color:#bf616a;">div</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">&lt;/</span><span style="color:#bf616a;">nav</span><span style="color:#c0c5ce;">&gt;
</span>
</code></pre>
<p>[ðŸŽ¬Â 17] Let me check how it looks now.</p>
<p><strong>![[Pasted image 20230506112354.png]]</strong></p>
<p>Cool! Having that, I can add my contact form to the page.</p>
<h1><a href="#contact-form" aria-hidden="true" class="anchor" id="contact-form"></a>Contact Form</h1>
<p>[ðŸŽ¬Â 18] I'm going to use the <code>form_for</code> helper, specifying the resource name this form will be designed for, and pointing to the path that it'll send my data to.</p>
<p>By default, It will try to send a <code>POST</code> request to my server, so we're going to add a corresponding action handling it very soon.</p>
<p>[ðŸŽ¬Â 19] For now let me just add two fields, one for email, and one for the actual message people will try to send to me.</p>
<pre lang="ruby" style="background-color:#2b303b;"><code>
<span style="color:#c0c5ce;">&lt;%= form_for(&quot;</span><span style="color:#a3be8c;">contact</span><span style="color:#c0c5ce;">&quot;, routes.path(</span><span style="color:#a3be8c;">:contact</span><span style="color:#c0c5ce;">), </span><span style="color:#b48ead;">class</span><span style="color:#c0c5ce;">: &quot;</span><span style="color:#a3be8c;">form-horizontal</span><span style="color:#c0c5ce;">&quot;) </span><span style="color:#b48ead;">do </span><span style="color:#c0c5ce;">|</span><span style="color:#bf616a;">f</span><span style="color:#c0c5ce;">| %&gt;
</span><span style="color:#a3be8c;">  &lt;div class=&quot;field&quot;</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">    &lt;%= f.label &quot;</span><span style="color:#a3be8c;">email</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#b48ead;">class</span><span style="color:#c0c5ce;">: &#39;</span><span style="color:#a3be8c;">label</span><span style="color:#c0c5ce;">&#39; %&gt;
</span><span style="color:#a3be8c;">    &lt;%= f.email_field &quot;email&quot;, class: &quot;input&quot; %</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">  &lt;/div&gt;
</span><span style="color:#c0c5ce;">  &lt;div </span><span style="color:#b48ead;">class</span><span style="color:#c0c5ce;">=&quot;</span><span style="color:#a3be8c;">field</span><span style="color:#c0c5ce;">&quot;&gt;
</span><span style="color:#c0c5ce;">    &lt;%= f.label &quot;</span><span style="color:#a3be8c;">message</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#b48ead;">class</span><span style="color:#c0c5ce;">: &quot;</span><span style="color:#a3be8c;">label</span><span style="color:#c0c5ce;">&quot; %&gt;
</span><span style="color:#a3be8c;">    &lt;%= f.text_area &quot;message&quot;, class: &quot;textarea&quot; %</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">  &lt;/div&gt;
</span><span style="color:#c0c5ce;">  &lt;div </span><span style="color:#b48ead;">class</span><span style="color:#c0c5ce;">=&quot;</span><span style="color:#a3be8c;">field</span><span style="color:#c0c5ce;">&quot;&gt;
</span><span style="color:#c0c5ce;">    &lt;%= f.submit &quot;</span><span style="color:#a3be8c;">Create</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#b48ead;">class</span><span style="color:#c0c5ce;">: &quot;</span><span style="color:#a3be8c;">button is-link</span><span style="color:#c0c5ce;">&quot; %&gt;
</span><span style="color:#a3be8c;">  &lt;/div</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">&lt;% </span><span style="color:#b48ead;">end </span><span style="color:#c0c5ce;">%&gt;
</span>
</code></pre>
<p>All those HTML classes are just for making it look pretty, you'll probably want to adjust them to your own needs of course.</p>
<p>[ðŸŽ¬Â 20] Finally, I'll add the <em>submit</em> button, using the <code>submit</code> helper called on my form object.</p>
<p>[ðŸŽ¬Â 21] With this, my form is ready for basic usage.</p>
<p>![[Pasted image 20230506113157.png]]</p>
<h1><a href="#post-action" aria-hidden="true" class="anchor" id="post-action"></a>Post Action</h1>
<p>Of course, to make it work, I need to add the <code>POST</code> action to my page, that will serve under the <code>/contact</code> path.</p>
<p>[ðŸŽ¬Â 22] First I'll add the route to the config, and then the action. I could use the generator here as I've shown in <a href="/episodes/18-hanami-actions-basics">episode 18</a> but I never was a big fan of generators however useful they are.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#65737e;"># slices/main/config/routes.rb
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">post &quot;</span><span style="color:#a3be8c;">/contact</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#a3be8c;">to: </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">contact.send</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#a3be8c;">as: </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">contact</span><span style="color:#c0c5ce;">&#39;
</span>
</code></pre>
<p>[ðŸŽ¬Â 23] Then in the action file, I'll use the <code>before</code> callback, to deserialize my form input parameters.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#65737e;"># slices/main/actions/contact/send.rb
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Main
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Actions
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Contact
</span><span style="color:#c0c5ce;">      </span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Send </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">Main::Action
</span><span style="color:#c0c5ce;">        before </span><span style="color:#a3be8c;">:deserialize
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">handle</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">request</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">response</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">          pp response[</span><span style="color:#a3be8c;">:contact</span><span style="color:#c0c5ce;">]
</span><span style="color:#c0c5ce;">          response.redirect routes.path(</span><span style="color:#a3be8c;">:contact</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">private
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">deserialize</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">request</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">response</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">          response[</span><span style="color:#a3be8c;">:contact</span><span style="color:#c0c5ce;">] = request.params[</span><span style="color:#a3be8c;">:contact</span><span style="color:#c0c5ce;">]
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">      </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span>
</code></pre>
<p>[ðŸŽ¬Â 24] Having that done, I'll print my input parameters on the screen and then redirect to the standard contact page.</p>
<p>![[Pasted image 20230506114202.png]]</p>
<p>All works! Great! However, we can do better to handle my form data in all cases.</p>
<h1><a href="#showing-form-errors" aria-hidden="true" class="anchor" id="showing-form-errors"></a>Showing form errors</h1>
<p>[ðŸŽ¬Â 25] If I'll fill my form correctly, all is fine, but I'd love to have my fields set to required and validate against incorrect values, properly showing the error to the user.</p>
<p>In that case, I'll also want to have my input values preserved after submitting the form, so let's do it all.</p>
<h1><a href="#action-validation" aria-hidden="true" class="anchor" id="action-validation"></a>Action validation</h1>
<p>[ðŸŽ¬Â 26] First, I'm going to define basic input validations using the <code>params</code> block.</p>
<p>Let's just set both email and message inputs as required to be filled in, and wrapped by a <em>contact</em> object.</p>
<pre lang="ruby" style="background-color:#2b303b;"><code>
<span style="color:#65737e;"># slices/main/actions/contact/send.rb
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">params </span><span style="color:#b48ead;">do
</span><span style="color:#c0c5ce;">  required(</span><span style="color:#a3be8c;">:contact</span><span style="color:#c0c5ce;">).schema </span><span style="color:#b48ead;">do
</span><span style="color:#c0c5ce;">    required(</span><span style="color:#a3be8c;">:email</span><span style="color:#c0c5ce;">).filled(</span><span style="color:#a3be8c;">:str?</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">    required(</span><span style="color:#a3be8c;">:message</span><span style="color:#c0c5ce;">).filled(</span><span style="color:#a3be8c;">:str?</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span>
</code></pre>
<p>[ðŸŽ¬Â 27] Having that, I can add the <code>before</code> block and handle this validation check.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#c0c5ce;">before </span><span style="color:#a3be8c;">:deserialize</span><span style="color:#c0c5ce;">, </span><span style="color:#a3be8c;">:validate
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;"># ...
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">private
</span><span style="color:#c0c5ce;">  
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">validate</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">request</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">response</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">return if</span><span style="color:#c0c5ce;"> request.params.valid?
</span><span style="color:#c0c5ce;">   </span><span style="color:#65737e;"># handle invalid requests here
</span><span style="color:#b48ead;">end
</span>
</code></pre>
<p>[ðŸŽ¬Â 28] With this, in case my parameters are valid, my action will just continue normally, but in case of failure, I want to render the show view of my contact enriched by the error messages and contact object.</p>
<p>[ðŸŽ¬Â 29] Because I don't have a view defined for the <em>send</em> action, my <code>view</code> variable will be empty and because I want to use my contact <em>show</em> view, I'm going to import it as a dependency</p>
<pre lang="ruby" style="background-color:#2b303b;"><code>
<span style="color:#8fa1b3;">include </span><span style="color:#ebcb8b;">Deps</span><span style="color:#c0c5ce;">[
</span><span style="color:#c0c5ce;"> </span><span style="color:#a3be8c;">failure_view: </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">views.contact.show</span><span style="color:#c0c5ce;">&#39;
</span><span style="color:#c0c5ce;">]
</span>
</code></pre>
<p>[ðŸŽ¬Â 30] Now in my validation method, I can render this, passing some input data to expose them in the template later.</p>
<p>I'll pass the <em>contact</em> object, and the <em>errors</em> hash, and after that I'll halt the further processing, rendering the page with the <em>422</em> HTTP status code and the rendered body.</p>
<pre lang="ruby" style="background-color:#2b303b;"><code>
<span style="color:#c0c5ce;">  errors = request.params.errors
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">  body = response.render(
</span><span style="color:#c0c5ce;">    failure_view,
</span><span style="color:#c0c5ce;">    </span><span style="color:#a3be8c;">contact:</span><span style="color:#c0c5ce;"> response[</span><span style="color:#a3be8c;">:contact</span><span style="color:#c0c5ce;">],
</span><span style="color:#c0c5ce;">    </span><span style="color:#a3be8c;">errors:</span><span style="color:#c0c5ce;"> errors[</span><span style="color:#a3be8c;">:contact</span><span style="color:#c0c5ce;">]
</span><span style="color:#c0c5ce;">  )
</span><span style="color:#c0c5ce;">  halt </span><span style="color:#d08770;">422</span><span style="color:#c0c5ce;">, body
</span><span style="color:#b48ead;">end
</span>
</code></pre>
<p>[ðŸŽ¬Â 31] Now let me jump into the view.</p>
<h1><a href="#preserving-form-input-data" aria-hidden="true" class="anchor" id="preserving-form-input-data"></a>Preserving form input data</h1>
<p>Here I'm going to add two new exposures and set the default value to them to be sure my templates won't need to deal with <code>nil</code> values.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#65737e;"># slices/main/views/contact/show.html.erb
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">expose </span><span style="color:#a3be8c;">:contact</span><span style="color:#c0c5ce;">, </span><span style="color:#a3be8c;">default: </span><span style="color:#c0c5ce;">{}
</span><span style="color:#c0c5ce;">expose </span><span style="color:#a3be8c;">:errors</span><span style="color:#c0c5ce;">, </span><span style="color:#a3be8c;">default: </span><span style="color:#c0c5ce;">{}
</span>
</code></pre>
<p>[ðŸŽ¬Â 32] Now I can access both of my variables in the template itself. To preserve the value of the input, I'll set the <code>value</code> option to email extracted from the contact's hash. Then I'll repeat the same for the <em>message</em> input.</p>
<pre style="background-color:#2b303b;" lang="html"><code>
<span style="color:#c0c5ce;">&lt;%= f.email_field &quot;email&quot;, value: contact[:email], class: &quot;input&quot; %&gt;
</span><span style="color:#c0c5ce;">&lt;%= f.text_area &quot;message&quot;, value: contact[:message], class: &quot;textarea&quot; %&gt;
</span>
</code></pre>
<p>[ðŸŽ¬Â 33] With this, below, I'm going to show the errors for the given field. No prettifying at this point, let's just check what will happen when I'll render the raw error messages.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#c0c5ce;">&lt;%= errors[</span><span style="color:#a3be8c;">:email</span><span style="color:#c0c5ce;">] %&gt;
</span>
</code></pre>
<p>[ðŸŽ¬Â 34] When I visit the browser now, you'll see that my field values are preserved, but the errors presentation could be done better.</p>
<p>![[Pasted image 20230506180509.png]]</p>
<p>Let's take care of this next</p>
<h1><a href="#rendering-better-errors" aria-hidden="true" class="anchor" id="rendering-better-errors"></a>Rendering better errors</h1>
<p>[ðŸŽ¬Â 35] I'm going to create a partial for my form input errors, which will accept an error message, and will wrap it in a properly styled paragraph.</p>
<pre lang="html" style="background-color:#2b303b;"><code>
<span style="color:#c0c5ce;"># slices/main/templates/contact/_form_error.html.erb
</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">p </span><span style="color:#d08770;">class</span><span style="color:#c0c5ce;">=&#39;</span><span style="color:#a3be8c;">help is-danger</span><span style="color:#c0c5ce;">&#39;&gt;&lt;%= message %&gt;&lt;/</span><span style="color:#bf616a;">p</span><span style="color:#c0c5ce;">&gt;
</span>
</code></pre>
<p>[ðŸŽ¬Â 36] Now to render it, I'd need to visit back the template page and call a <code>render</code> method, passing in a partial name, and the locals, which in this case, is a <em>message</em> string.</p>
<pre style="background-color:#2b303b;" lang="html"><code>
<span style="color:#c0c5ce;"># slices/main/templates/contact/show.html.erb
</span><span style="color:#c0c5ce;">&lt;%= render :form_error, message: errors[:email]) %&gt;
</span>
</code></pre>
<p>[ðŸŽ¬Â 37] I want the error message to be properly formatted, so if you've ever seen views in Rails, you may expect that I'll just add some formatting logic to the argument, and that's it.</p>
<p>Sure thing, this will work. Sort of.</p>
<pre style="background-color:#2b303b;" lang="html"><code>
<span style="color:#c0c5ce;">&lt;%= render :form_error, message: errors[:email].join(&#39;, &#39;) %&gt;
</span>
</code></pre>
<p>[ðŸŽ¬Â 38] In case there are no errors in the email, the value here will be nil, so my application will crash.</p>
<p>It's ok, though, I can add one more method, forcing string transformation before calling <code>join</code>.</p>
<pre style="background-color:#2b303b;" lang="html"><code>
<span style="color:#c0c5ce;">&lt;%= render :form_error, message: errors[:email].to_s.join(&#39;, &#39;) %&gt;
</span>
</code></pre>
<p>[ðŸŽ¬Â 39] But it's just bad because of two reasons.</p>
<ol>
<li>Ruby logic leaks to views</li>
<li>When an error is empty, I'll still render the paragraph and adding <code>if</code> statement will leak even more logic to templates.</li>
<li>This is bug-prone and harder to test.</li>
</ol>
<p>So how can we improve on this?</p>
<p>First of all, let me decorate my errors</p>
<h1><a href="#decorating-errors-with-parts" aria-hidden="true" class="anchor" id="decorating-errors-with-parts"></a>Decorating errors with Parts</h1>
<p>[ðŸŽ¬Â 40] Hanami has a built-in solution for decorating dynamic data in templates, and it's done using an abstraction named <em>parts</em>.</p>
<p><em>Part</em> is a ruby object that encapsulates decoration logic for parts of views, in this case, an error message.</p>
<p>[ðŸŽ¬Â 41] Each exposed method in the view is wrapped by a corresponding <em>part</em> object. If the <em>part</em> for the given exposure does not exist, it's wrapped by the general <code>Hanami::View::Part</code> instance, and all the methods on that object are passed to the original value using <code>method_missing</code> mechanics.</p>
<p>How that can be helpful?</p>
<p>Let me show you.</p>
<h1><a href="#form-errors-part-object" aria-hidden="true" class="anchor" id="form-errors-part-object"></a>Form errors Part object</h1>
<p>[ðŸŽ¬Â 42] In my views folder, I'll create a new one, named <code>parts</code>. Inside, I'll create the <code>Errors</code> part class, which inherits from the general part for the <code>main</code> slice.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#65737e;"># slices/main/views/parts/errors.rb
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Main
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Views
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">module </span><span style="color:#c0c5ce;">Parts
</span><span style="color:#c0c5ce;">      </span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Errors </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">Part
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">message</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">          msgs = value[key] || []
</span><span style="color:#c0c5ce;">          msgs.join(&quot;</span><span style="color:#a3be8c;">, </span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">      </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">end
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span>
</code></pre>
<p>[ðŸŽ¬Â 43] Within this class, I'm going to define a <code>message</code> method, that accepts the error field name.</p>
<p>I can now extract here the logic related to joining my error messages, test this in isolation, and document using <a href="/episodes/17-inline-documentation-with-yard">inline documentation</a> if needed!</p>
<p>[ðŸŽ¬Â 44] My view gets simpler, but this still does not resolve the conditional rendering error.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#c0c5ce;">&lt;%= render </span><span style="color:#a3be8c;">:form_error</span><span style="color:#c0c5ce;">, </span><span style="color:#a3be8c;">message:</span><span style="color:#c0c5ce;"> errors.message(</span><span style="color:#a3be8c;">:email</span><span style="color:#c0c5ce;">) %&gt;
</span>
</code></pre>
<p>[ðŸŽ¬Â 45] Fortunately, I can also render the partial from within the <em>part's</em> method, and add all the conditional rules here!</p>
<p>In case the message is empty, I'll just return the empty string, so it'll never affect my HTML document, and only if I get the error, I'll render the proper partial.</p>
<pre style="background-color:#2b303b;" lang="ruby"><code>
<span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">message</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">  msgs = value[key] || []
</span><span style="color:#c0c5ce;">  msg = msgs.</span><span style="color:#96b5b4;">to_s</span><span style="color:#c0c5ce;">.join(&quot;</span><span style="color:#a3be8c;">, </span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> msg </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> msg.empty?
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">  render </span><span style="color:#a3be8c;">:form_error</span><span style="color:#c0c5ce;">, </span><span style="color:#a3be8c;">message:</span><span style="color:#c0c5ce;"> msg
</span><span style="color:#b48ead;">end
</span>
</code></pre>
<p>[ðŸŽ¬Â 46] Now I can simplify my view quite a lot, getting rid of the whole logic, and making sure my views have no room for random errors.</p>
<pre style="background-color:#2b303b;" lang="html"><code>
<span style="color:#c0c5ce;"># slices/main/views/contact/show.html.erb
</span><span style="color:#c0c5ce;">&lt;%= errors.message(:email) %&gt;
</span>
</code></pre>
<p>I hope you're excited as I am, and if not, try out hanami views to check it out yourself.</p>
<h1><a href="#summary" aria-hidden="true" class="anchor" id="summary"></a>Summary</h1>
<p>[ðŸŽ¬Â 47] The built-in solution of extended view architecture in Hanami allows us to create very complex applications because no matter how much they scale, our templates can still stay simple, easy to change and modify, with frontend developers barely noticing Ruby.</p>
<p>[ðŸŽ¬Â 48] We can extract all our logic to pure ruby objects, that have no dependencies and can be tested in isolation, which makes our apps more reliable and gives us more fun when working with them.</p>
<p>[ðŸŽ¬Â 49] Unfortunately, that's all I have for you today, but stay tuned for the next episode, where I'll implement the actual email sending functionality.</p>
<p><a href="https://www.notion.so/CTA-2-Like-and-Subscribe-6968f8aadb374d7e90024fb604b279a4">CTA-2 - Like-and-Subscribe</a></p>
<h1><a href="#thanks" aria-hidden="true" class="anchor" id="thanks"></a>Thanks</h1>
<p>[ðŸŽ¬Â 50] I want to especially thank my recent sponsors,</p>
<ul>
<li><a href="https://github.com/maximgurin">Maxim Gurin</a></li>
<li><a href="http://prowly.com/">prowly.com</a></li>
<li><a href="https://twitter.com/akilasy">Akilas Yemane</a></li>
</ul>
<p>andÂ <a href="https://pro.hanamimastery.com/">all the Hanami Mastery PRO subscirbers</a>, for supporting this project, I really appreciate it!</p>
<p><a href="https://www.notion.so/CTA-5-Support-3bb0101351494acfa27975ce338d7454">CTA-5 - Support!</a></p>
